language: c
os: linux
dist: bionic
addons:
  apt:
    packages:
      - flex
      - bison
      - libsqlite3-dev
      - libsctp-dev
      - libradcli-dev
      - libhiredis-dev
      - unixodbc-dev
      - libconfuse-dev
      - libmysqlclient-dev
      - libexpat1-dev
      - libxml2-dev
      - libpq-dev
      - zlib1g-dev
      - libperl-dev
      - libsnmp-dev
      - libdb-dev
      - libldap2-dev
      - libcurl4-gnutls-dev
      - libgeoip-dev
      - libpcre3-dev
      - libmemcached-dev
      - libmicrohttpd-dev
      - librabbitmq-dev
      - liblua5.1-0-dev
      - libncurses5-dev
      - libjson-c-dev
      - uuid-dev
      - python-dev
#      - libjwt-dev
before_script:
  - sh scripts/build/setup_tap.sh
script:
  - CC_EXTRA_OPTS=${CC_EXTRA_OPTS:-"-Werror -Idist/libtap"} make \
      LD_EXTRA_OPTS=-Ldist/libtap FASTER=1 NICER=0 \
      exclude_modules="db_oracle osp sngtc cachedb_cassandra cachedb_couchbase \
      cachedb_mongodb auth_jwt" ${MAKE_TGT:-all opensips_test}
  - set -e; if [ -e opensips_test ]; then ./opensips_test; fi
notifications:
  irc:
    channels:
      - "chat.freenode.net#opensips"
    on_success: change
    on_failure: always
  slack:
    secure: MnRvw68QpJHUSZ/IRGUlAjQ62xs3LtEZ0g3pG7Bms0XotuK+YxmSZh7BgV61utuya295LTvdWZQYiutJ4+iPKdF7Mb1KCzaUbY6nrGaIbqif10CKwfIFRsENMhYUKOXdvg52103GNq3/V3/6PGX7Jtiaox9lHcfRhvljs+cUgSk=
    on_success: change
    on_failure: always
jobs:
  include:
    - name: "Build Core with GCC 7 @ Ubuntu 18 (MIPS64)"
      compiler: gcc
      env:
        - CC=mips64-linux-gnuabi64-gcc AR=mips64-linux-gnuabi64-ar RANLIB=mips64-linux-gnuabi64-ranlib
        - CC_EXTRA_OPTS="-Werror -Idist/libtap"
        - MAKE_TGT="opensips opensips_test"
      before_install:
        - sudo apt-get -y install gcc-mips64-linux-gnuabi64 libc-dev-mips64-cross qemu-user-static
